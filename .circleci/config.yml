version: 2.0

jobs:
  compile:
    docker:
      - image: circleci/clojure:lein-2.7.1
    working_directory: ~/realworld-backend
    steps:
      - checkout
      - attach_workspace:
          at: ~/realworld-backend
      - restore_cache:
          key: realworld-backend-cache
      - run:
          name: Compile changed projects with using time.circleci.edn
          command: lein polylith compile circleci
      - save_cache:
          key: realworld-backend-cache
          paths:
            - ~/.m2
            - ~/.lein
      - persist_to_workspace:
          root: .
          paths:
            - .
  test:
    docker:
      - image: circleci/clojure:lein-2.7.1
    working_directory: ~/realworld-backend
    steps:
      - attach_workspace:
          at: ~/realworld-backend
      - restore_cache:
          key: realworld-backend-cache
      - run:
          name: Test changed projects with using time.circleci.edn
          command: lein polylith test circleci
      - save_cache:
          key: realworld-backend-cache
          paths:
            - ~/.m2
            - ~/.lein
      - persist_to_workspace:
          root: .
          paths:
            - .

  build:
    docker:
      - image: circleci/clojure:lein-2.7.1
    working_directory: ~/realworld-backend
    steps:
      - attach_workspace:
          at: ~/realworld-backend
      - restore_cache:
          key: realworld-backend-cache
      - run:
          name: Build changed projects with using time.circleci.edn
          command: lein polylith build circleci
      - save_cache:
          key: realworld-backend-cache
          paths:
            - ~/.m2
            - ~/.lein
      - persist_to_workspace:
          root: .
          paths:
            - .

  artifacts:
    machine:
      enabled: true
    working_directory: ~/realworld-backend
    steps:
      - attach_workspace:
          at: ~/realworld-backend
      - run:
          name: Find built systems and move artifacts
          command: |
            mkdir -p artifacts

            built_systems=`lein polylith changes s circleci`
            for system in $built_systems; do
              artifact="systems/""$system""/target/""$system"".war"
              cp $artifact artifacts/.
            done
      - store_artifacts:
          path: artifacts
          destination: artifacts
      - persist_to_workspace:
          root: .
          paths:
            - .

  success:
    docker:
      - image: circleci/clojure:lein-2.7.1
    working_directory: ~/realworld-backend
    steps:
      - attach_workspace:
          at: ~/realworld-backend
      - restore_cache:
          key: realworld-backend-cache
      - run:
          name: Set new :last-successful-build time to time.circleci.edn
          command: lein polylith success circleci
      - save_cache:
          key: realworld-backend-cache
          paths:
            - ~/.m2
            - ~/.lein
      - persist_to_workspace:
          root: .
          paths:
            - .

  commit:
    machine:
      enabled: true
    working_directory: ~/realworld-backend
    steps:
      - add_ssh_keys:
          fingerprints:
            - "e3:f1:38:86:f7:c2:0e:f3:ae:96:29:ff:2e:13:a3:16"
      - attach_workspace:
          at: ~/realworld-backend
      - run:
          name: Commit time.circleci.edn to git
          command: |
            git config credential.helper 'cache --timeout=120'
            git config user.email "me@furkanbayraktar.com"
            git config user.name "CircleCI"
            git add .
            git commit -m "Updated time.circleci.edn"
            git push
      - persist_to_workspace:
          root: .
          paths:
            - .

workflows:
  version: 2
  test-build-success:
    jobs:
      - compile
      - test:
          requires:
            - compile
      - build:
          requires:
            - test
      - artifacts:
          requires:
            - build
          filters:
            branches:
              only:
                - master
                - develop
      - success:
          requires:
            - artifacts
          filters:
            branches:
              only:
                - master
                - develop
      - commit:
          requires:
            - success
          filters:
            branches:
              only:
                - master
                - develop
